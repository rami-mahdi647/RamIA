# Nginx reverse proxy con TLS, rate limit y CORS/CSP. Sin geoblocking.
# Coloca tus certificados en /etc/nginx/certs (o usa un Ingress con cert-manager en K8s).

limit_req_zone $binary_remote_addr zone=perip:10m rate=120r/m;

server {
  listen 80;
  listen 443 ssl http2;

  # ssl_certificate /etc/nginx/certs/fullchain.pem;
  # ssl_certificate_key /etc/nginx/certs/privkey.pem;

  # Seguridad b치sica de transporte
  add_header Strict-Transport-Security "max-age=63072000" always;

  # CORS (ajusta tu origin)
  add_header Access-Control-Allow-Origin $http_origin always;
  add_header Access-Control-Allow-Credentials true always;
  add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin" always;

  # CSP fuerte: ajusta connect-src para RPC/bundler
  add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https://rpc.example https://bundler.example; frame-ancestors 'none'; object-src 'none'; base-uri 'self'" always;

  # Tama침o m치ximo de body (evita abusos)
  client_max_body_size 5m;

  location / {
    limit_req zone=perip burst=60 nodelay;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;
    proxy_pass http://app:3000;
  }

  # Respuesta r치pida a OPTIONS
  if ($request_method = OPTIONS) {
    return 204;
  }
}

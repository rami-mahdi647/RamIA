<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Payment Confirmed</title>
<style>body{font-family:system-ui;background:#0d1530;color:#eef;padding:24px}code,textarea{width:100%;background:#070d1e;color:#cfe;border:1px solid #2e4f9f;border-radius:8px;padding:10px}.btn{display:inline-block;margin-top:10px;padding:9px 12px;background:#0a5d7f;color:#fff;border-radius:8px;text-decoration:none;border:0}</style>
</head><body>
<h1>Payment confirmed</h1>
<p>Your checkout is complete. Fetch your grant token, then redeem it in your local node endpoint <code>/api/redeem_grant</code>.</p>
<p><button class="btn" id="load">Load grant token</button></p>
<textarea id="token" rows="8" placeholder="Grant token will appear here"></textarea>
<script>
const params = new URLSearchParams(location.search);
const sid = params.get('session_id');
const grantKey = params.get('grant_key');
const out = document.getElementById('token');
document.getElementById('load').onclick = async () => {
  if (!sid) { out.value = 'Missing session_id in URL.'; return; }
  if (!grantKey) { out.value = 'Missing grant_key in URL. Re-open the Stripe success link.'; return; }

  const query = new URLSearchParams({ session_id: sid, grant_key: grantKey });
  const res = await fetch(`/.netlify/functions/get_grant_token?${query.toString()}`);
  const data = await res.json();

  if (!res.ok) {
    if (res.status === 403) out.value = 'Authorization failed: invalid retrieval key.';
    else if (res.status === 410) out.value = 'Grant token is no longer available (expired or already read).';
    else out.value = data.error || `Error (${res.status})`;
    return;
  }

  out.value = data.grant_token || 'Grant token missing in response.';
};
</script>
</body></html>
